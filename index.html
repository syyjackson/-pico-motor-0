<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motor Control</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
        .motor-control { margin: 20px; }
        .pattern-btn { margin: 5px; padding: 5px 10px; }
        .active { background-color: #4CAF50; color: white; }
    </style>
</head>
<body>
    <h1>Motor Control Interface</h1>

    <div class="motor-control">
        <h2>Motor 1</h2>
        <label for="m1-speed">Speed: <span id="m1-speed-value">0</span>%</label><br>
        <input type="range" id="m1-speed" min="0" max="100" value="0"><br>
        <label for="m1-direction">Direction:</label>
        <select id="m1-direction">
            <option value="0">Stop</option>
            <option value="1">Forward</option>
            <option value="-1">Reverse</option>
        </select><br>
        <button id="m1-power">Awaken</button>
        <div id="m1-patterns">
            <button class="pattern-btn" data-pattern="none">Steady Revenge</button>
            <button class="pattern-btn" data-pattern="heartbeat">Heartbeat</button>
            <button class="pattern-btn" data-pattern="wave">Wave</button>
            <button class="pattern-btn" data-pattern="quick">Quick</button>
            <button class="pattern-btn" data-pattern="pulse">Pulse</button>
            <button class="pattern-btn" data-pattern="buzz">Buzz</button>
            <button class="pattern-btn" data-pattern="stutter">Stutter</button>
        </div>
    </div>

    <div class="motor-control">
        <h2>Random Attack Timer</h2>
        <label for="start-time">Start Time (HH:MM):</label>
        <input type="text" id="start-time" placeholder="00:00"><br>
        <label for="period">Period (hours):</label>
        <input type="number" id="period" min="1" value="1"><br>
        <button id="start-timer">Random Attack</button>
        <button id="stop-timer">Stop Timer</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script>
        const client = new Paho.MQTT.Client("test.mosquitto.org", 8081, "client_" + new Date().getTime());
        client.connect({ onSuccess: onConnect });

        function onConnect() {
            console.log("Connected to MQTT broker");
            client.subscribe("pico/system/feedback");
            client.onMessageArrived = onMessageArrived;
        }

        function onMessageArrived(message) {
            console.log("Received MQTT message:", message.payloadString);
            const data = JSON.parse(message.payloadString);
            if (data.status === "timer_set") {
                console.log(`Timer set for ${data.period} hours`);
            } else if (data.status === "timer_stopped") {
                console.log("Timer stopped");
            }
        }

        function publishMessage(topic, message) {
            const msg = new Paho.MQTT.Message(JSON.stringify(message));
            msg.destinationName = topic;
            console.log(`Publishing to ${topic}: ${JSON.stringify(message)}`);
            client.send(msg);
        }

        // Motor 1 Controls
        const m1Speed = document.getElementById("m1-speed");
        const m1SpeedValue = document.getElementById("m1-speed-value");
        const m1Direction = document.getElementById("m1-direction");
        const m1PowerBtn = document.getElementById("m1-power");
        const m1PatternBtns = document.querySelectorAll("#m1-patterns .pattern-btn");
        let m1PowerState = false;

        m1Speed.oninput = () => {
            m1SpeedValue.textContent = m1Speed.value;
            if (!timerActive) {  // Only send speed updates when timer isnâ€™t active
                publishMessage("pico/motor1/control", {
                    speed: parseInt(m1Speed.value),
                    direction: parseInt(m1Direction.value)
                });
            }
        };

        m1Direction.onchange = () => {
            if (!timerActive) {
                publishMessage("pico/motor1/control", {
                    speed: parseInt(m1Speed.value),
                    direction: parseInt(m1Direction.value)
                });
            }
        };

        m1PowerBtn.onclick = () => {
            m1PowerState = !m1PowerState;
            m1PowerBtn.textContent = m1PowerState ? "Sleep" : "Awaken";
            publishMessage("pico/motor1/control", {
                power: m1PowerState,
                speed: parseInt(m1Speed.value),  // Include current speed
                direction: parseInt(m1Direction.value)
            });
        };

        m1PatternBtns.forEach(btn => {
            btn.onclick = () => {
                m1PatternBtns.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                if (!timerActive) {
                    publishMessage("pico/motor1/control", {
                        pattern: btn.dataset.pattern,
                        speed: parseInt(m1Speed.value),
                        direction: parseInt(m1Direction.value)
                    });
                }
            };
        });

        // Timer Controls
        const startTimerBtn = document.getElementById("start-timer");
        const stopTimerBtn = document.getElementById("stop-timer");
        let timerActive = false;

        startTimerBtn.onclick = () => {
            const startTime = document.getElementById("start-time").value;
            const period = document.getElementById("period").value;
            if (startTime && period) {
                timerActive = true;
                publishMessage("pico/system/timer", {
                    start_time: startTime,
                    period: parseInt(period)
                });
            }
        };

        stopTimerBtn.onclick = () => {
            timerActive = false;
            publishMessage("pico/system/timer", { stop: true });
        };
    </script>
</body>
</html>
